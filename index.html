<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Spendly">
<meta name="theme-color" content="#0f1117">
<title>Spendly â€” Daily Expenses</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');

:root {
  --bg: #0f1117;
  --card: #181c26;
  --card2: #1e2330;
  --border: #2a2f3e;
  --border2: #343b4f;
  --text: #eef0f6;
  --muted: #7b82a0;
  --muted2: #3d4460;
  --purchase: #3b82f6;
  --purchase-dim: rgba(59,130,246,0.13);
  --person: #f59e0b;
  --person-dim: rgba(245,158,11,0.13);
  --green: #22c55e;
  --green-dim: rgba(34,197,94,0.12);
  --red: #ef4444;
  --red-dim: rgba(239,68,68,0.12);
  --accent: #6366f1;
  --accent-dim: rgba(99,102,241,0.15);
}

*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--text);font-family:'Sora',sans-serif;font-size:15px;-webkit-font-smoothing:antialiased}

/* â”€â”€ SCREENS â”€â”€ */
.screen{position:fixed;inset:0;display:flex;flex-direction:column;background:var(--bg);transition:opacity .22s,transform .22s;overflow:hidden}
.screen.hidden{opacity:0;pointer-events:none;transform:translateY(10px)}

/* â”€â”€ BOTTOM NAV â”€â”€ */
.bottom-nav{display:flex;background:var(--card);border-top:1px solid var(--border);flex-shrink:0;padding-bottom:env(safe-area-inset-bottom,0)}
.nav-btn{flex:1;padding:10px 0 8px;display:flex;flex-direction:column;align-items:center;gap:3px;border:none;background:none;color:var(--muted);font-family:'Sora',sans-serif;font-size:10px;font-weight:500;cursor:pointer;transition:color .15s;letter-spacing:.02em}
.nav-btn.active{color:var(--accent)}
.nav-icon{font-size:20px;line-height:1}

/* â”€â”€ TAB CONTENT â”€â”€ */
.tab-content{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch}
.tab-page{display:none;flex-direction:column;height:100%}
.tab-page.active{display:flex}

/* â”€â”€ TOP BAR â”€â”€ */
.topbar{padding:48px 18px 14px;flex-shrink:0}
.topbar-row{display:flex;align-items:center;justify-content:space-between}
.page-title{font-size:22px;font-weight:700;letter-spacing:-.03em}
.page-sub{font-size:12px;color:var(--muted);margin-top:2px}

/* â”€â”€ SUMMARY CARD â”€â”€ */
.summary-wrap{padding:0 16px 12px;flex-shrink:0}
.summary-card{background:linear-gradient(135deg,#1a1f35,#1e2440);border:1px solid var(--border2);border-radius:18px;padding:18px 20px;position:relative;overflow:hidden}
.summary-card::before{content:'';position:absolute;top:-30px;right:-30px;width:120px;height:120px;border-radius:50%;background:radial-gradient(circle,rgba(99,102,241,.15),transparent 70%)}
.summary-label{font-size:11px;color:var(--muted);letter-spacing:.08em;text-transform:uppercase;margin-bottom:4px}
.summary-amount{font-size:32px;font-weight:700;font-family:'JetBrains Mono',monospace;letter-spacing:-.02em;color:var(--text)}
.summary-currency{font-size:16px;color:var(--muted);margin-left:2px}
.summary-row{display:flex;gap:12px;margin-top:14px}
.summary-pill{flex:1;background:rgba(255,255,255,.04);border-radius:10px;padding:10px 12px}
.pill-label{font-size:10px;color:var(--muted);letter-spacing:.06em;text-transform:uppercase;margin-bottom:3px}
.pill-val{font-size:15px;font-weight:600;font-family:'JetBrains Mono',monospace}
.pill-val.blue{color:var(--purchase)}
.pill-val.amber{color:var(--person)}

/* â”€â”€ FILTER CHIPS â”€â”€ */
.filter-row{display:flex;gap:8px;padding:0 16px 12px;flex-shrink:0;overflow-x:auto;scrollbar-width:none}
.filter-row::-webkit-scrollbar{display:none}
.chip{padding:7px 16px;border-radius:100px;border:1px solid var(--border2);background:var(--card);color:var(--muted);font-size:12px;font-weight:500;cursor:pointer;white-space:nowrap;transition:all .15s;font-family:'Sora',sans-serif}
.chip.active-all{border-color:var(--accent);background:var(--accent-dim);color:var(--accent)}
.chip.active-purchase{border-color:var(--purchase);background:var(--purchase-dim);color:var(--purchase)}
.chip.active-person{border-color:var(--person);background:var(--person-dim);color:var(--person)}

/* â”€â”€ LIST â”€â”€ */
.list-scroll{flex:1;overflow-y:auto;padding:0 16px 100px;-webkit-overflow-scrolling:touch}
.date-group-label{font-size:11px;color:var(--muted);letter-spacing:.08em;text-transform:uppercase;padding:14px 0 8px;font-weight:600}

.entry-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px 16px;margin-bottom:9px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:background .12s;position:relative;overflow:hidden}
.entry-card:active{background:var(--card2)}
.entry-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;border-radius:3px 0 0 3px}
.entry-card.type-purchase::before{background:var(--purchase)}
.entry-card.type-person::before{background:var(--person)}

.entry-icon-wrap{width:40px;height:40px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.type-purchase .entry-icon-wrap{background:var(--purchase-dim)}
.type-person .entry-icon-wrap{background:var(--person-dim)}

.entry-info{flex:1;min-width:0}
.entry-title{font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.entry-meta{font-size:11px;color:var(--muted);margin-top:2px;display:flex;align-items:center;gap:6px}
.type-badge{font-size:9px;font-weight:600;letter-spacing:.06em;text-transform:uppercase;padding:2px 7px;border-radius:20px}
.badge-purchase{background:var(--purchase-dim);color:var(--purchase)}
.badge-person{background:var(--person-dim);color:var(--person)}

.entry-amount{font-family:'JetBrains Mono',monospace;font-size:15px;font-weight:700;text-align:right;flex-shrink:0}
.entry-amount.type-purchase{color:var(--purchase)}
.entry-amount.type-person{color:var(--person)}

.empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;padding:60px 20px;color:var(--muted);text-align:center}
.empty-icon{font-size:44px;opacity:.35}
.empty-text{font-size:14px;line-height:1.6}

/* â”€â”€ FAB â”€â”€ */
.fab{position:fixed;bottom:76px;right:18px;width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,#6366f1,#4f46e5);border:none;color:#fff;font-size:26px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 6px 24px rgba(99,102,241,.45);z-index:100;transition:transform .15s}
.fab:active{transform:scale(.92)}

/* â”€â”€ MODAL â”€â”€ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:200;display:flex;align-items:flex-end;backdrop-filter:blur(6px);transition:opacity .25s}
.modal-overlay.hidden{opacity:0;pointer-events:none}
.modal{width:100%;background:var(--card);border-radius:22px 22px 0 0;padding:0 0 env(safe-area-inset-bottom,24px);max-height:94vh;overflow-y:auto;transform:translateY(0);transition:transform .3s cubic-bezier(.32,.72,0,1)}
.modal-overlay.hidden .modal{transform:translateY(100%)}
.modal-handle{width:38px;height:4px;background:var(--border2);border-radius:2px;margin:12px auto 0}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px 16px;border-bottom:1px solid var(--border)}
.modal-title{font-size:17px;font-weight:700}
.modal-close{width:30px;height:30px;border-radius:50%;background:var(--card2);border:none;color:var(--muted);font-size:18px;display:flex;align-items:center;justify-content:center;cursor:pointer}
.modal-body{padding:20px}

/* TYPE TOGGLE */
.type-toggle{display:flex;background:var(--bg);border-radius:12px;padding:4px;margin-bottom:18px;gap:4px}
.type-opt{flex:1;padding:10px 8px;border-radius:9px;border:none;font-family:'Sora',sans-serif;font-size:13px;font-weight:600;cursor:pointer;text-align:center;transition:all .15s;color:var(--muted);background:none}
.type-opt.active-purchase{background:var(--purchase-dim);color:var(--purchase)}
.type-opt.active-person{background:var(--person-dim);color:var(--person)}

/* FIELDS */
.field-group{margin-bottom:15px}
.field-label{font-size:11px;font-weight:600;color:var(--muted);letter-spacing:.07em;text-transform:uppercase;margin-bottom:7px;display:block}
.field-input{width:100%;background:var(--bg);border:1px solid var(--border2);border-radius:10px;padding:13px 14px;color:var(--text);font-family:'Sora',sans-serif;font-size:15px;outline:none;transition:border-color .15s;appearance:none;-webkit-appearance:none}
.field-input:focus{border-color:var(--accent)}
.field-input::placeholder{color:var(--muted2)}
select.field-input{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%237b82a0' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center;padding-right:36px}
.amount-wrap{position:relative}
.currency-sym{position:absolute;left:14px;top:50%;transform:translateY(-50%);font-family:'JetBrains Mono',monospace;font-size:16px;color:var(--muted);font-weight:500;pointer-events:none}
.field-input.has-sym{padding-left:34px}

.save-btn{width:100%;padding:15px;border-radius:12px;border:none;background:linear-gradient(135deg,#6366f1,#4f46e5);color:#fff;font-family:'Sora',sans-serif;font-size:16px;font-weight:700;cursor:pointer;margin-top:6px;transition:opacity .15s}
.save-btn:active{opacity:.8}
.del-btn{width:100%;padding:13px;border-radius:12px;border:1px solid var(--red-dim);background:var(--red-dim);color:var(--red);font-family:'Sora',sans-serif;font-size:14px;font-weight:600;cursor:pointer;margin-top:10px}
.del-btn:active{background:rgba(239,68,68,.22)}

/* â”€â”€ SETTINGS â”€â”€ */
.settings-scroll{flex:1;overflow-y:auto;padding:0 16px 40px}
.section-title{font-size:11px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);padding:18px 0 10px}
.setting-card{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden;margin-bottom:10px}
.setting-row{display:flex;align-items:center;padding:15px 16px;gap:12px;border-bottom:1px solid var(--border)}
.setting-row:last-child{border-bottom:none}
.setting-icon{font-size:20px;width:36px;text-align:center;flex-shrink:0}
.setting-info{flex:1}
.setting-name{font-size:14px;font-weight:600}
.setting-desc{font-size:11px;color:var(--muted);margin-top:2px}
.setting-action{color:var(--muted);font-size:14px}

/* currency list */
.currency-item{display:flex;align-items:center;padding:13px 16px;gap:12px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .12s}
.currency-item:last-child{border-bottom:none}
.currency-item:active{background:var(--card2)}
.curr-sym{width:40px;height:40px;border-radius:11px;background:var(--accent-dim);display:flex;align-items:center;justify-content:center;font-family:'JetBrains Mono',monospace;font-size:17px;font-weight:700;color:var(--accent);flex-shrink:0}
.curr-info{flex:1}
.curr-name{font-size:14px;font-weight:600}
.curr-code{font-size:11px;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-top:1px}
.curr-active{font-size:18px}
.curr-delete{font-size:16px;color:var(--red);padding:4px 8px;background:none;border:none;cursor:pointer;opacity:.7}

/* add currency form */
.add-curr-form{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:10px}
.add-curr-title{font-size:13px;font-weight:700;color:var(--muted);margin-bottom:12px;text-transform:uppercase;letter-spacing:.07em}
.add-curr-row{display:flex;gap:10px;margin-bottom:10px}
.add-curr-input{flex:1;background:var(--bg);border:1px solid var(--border2);border-radius:9px;padding:11px 13px;color:var(--text);font-family:'Sora',sans-serif;font-size:14px;outline:none;transition:border-color .15s}
.add-curr-input:focus{border-color:var(--accent)}
.add-curr-input::placeholder{color:var(--muted2)}
.add-curr-btn{padding:11px 18px;border-radius:9px;border:none;background:var(--accent);color:#fff;font-family:'Sora',sans-serif;font-size:14px;font-weight:700;cursor:pointer;white-space:nowrap;transition:opacity .15s}
.add-curr-btn:active{opacity:.8}

/* â”€â”€ TOAST â”€â”€ */
.toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%) translateY(16px);background:var(--card2);border:1px solid var(--border2);border-radius:10px;padding:10px 20px;font-size:13px;font-weight:500;opacity:0;transition:all .25s;z-index:999;white-space:nowrap;pointer-events:none}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* â”€â”€ STATS PAGE â”€â”€ */
.stats-scroll{flex:1;overflow-y:auto;padding:0 16px 60px}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;margin-bottom:12px}
.stat-card-title{font-size:12px;font-weight:700;color:var(--muted);letter-spacing:.07em;text-transform:uppercase;margin-bottom:14px}
.stat-row{display:flex;justify-content:space-between;align-items:center;padding:9px 0;border-bottom:1px solid var(--border)}
.stat-row:last-child{border-bottom:none}
.stat-label{font-size:13px;color:var(--muted)}
.stat-val{font-size:14px;font-weight:700;font-family:'JetBrains Mono',monospace}
.bar-wrap{height:8px;background:var(--border);border-radius:4px;overflow:hidden;margin-top:6px}
.bar-fill{height:100%;border-radius:4px;transition:width .6s ease}
.bar-purchase{background:var(--purchase)}
.bar-person{background:var(--person)}

/* scrollbar */
::-webkit-scrollbar{width:3px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}
</style>
</head>
<body>

<!-- MAIN APP SCREEN -->
<div class="screen" id="app-screen">

  <!-- TAB: HOME -->
  <div class="tab-page active" id="tab-home">
    <div class="topbar">
      <div class="topbar-row">
        <div>
          <div class="page-title">Spendly ğŸ’¸</div>
          <div class="page-sub" id="today-date">Loading...</div>
        </div>
        <div style="font-size:11px;color:var(--muted);background:var(--card);border:1px solid var(--border);padding:5px 12px;border-radius:20px;font-weight:600" id="curr-badge">INR â‚¹</div>
      </div>
    </div>

    <div class="summary-wrap">
      <div class="summary-card">
        <div class="summary-label">Total Spent Today</div>
        <div class="summary-amount"><span id="sym-today"></span><span id="total-today">0.00</span></div>
        <div class="summary-row">
          <div class="summary-pill">
            <div class="pill-label">ğŸ›’ Purchases</div>
            <div class="pill-val blue"><span id="sym-p"></span><span id="total-purchase">0.00</span></div>
          </div>
          <div class="summary-pill">
            <div class="pill-label">ğŸ¤ To Person</div>
            <div class="pill-val amber"><span id="sym-pp"></span><span id="total-person">0.00</span></div>
          </div>
        </div>
      </div>
    </div>

    <div class="filter-row">
      <div class="chip active-all" onclick="setFilter('all',this)">All</div>
      <div class="chip" onclick="setFilter('purchase',this)">ğŸ›’ Purchases</div>
      <div class="chip" onclick="setFilter('person',this)">ğŸ¤ To Person</div>
    </div>

    <div class="list-scroll" id="entries-list"></div>
    <button class="fab" onclick="openAddModal()">+</button>
  </div>

  <!-- TAB: STATS -->
  <div class="tab-page" id="tab-stats">
    <div class="topbar">
      <div class="page-title">Statistics ğŸ“Š</div>
      <div class="page-sub">All time overview</div>
    </div>
    <div class="stats-scroll" id="stats-content"></div>
  </div>

  <!-- TAB: SETTINGS -->
  <div class="tab-page" id="tab-settings">
    <div class="topbar">
      <div class="page-title">Settings âš™ï¸</div>
      <div class="page-sub">Customize your app</div>
    </div>
    <div class="settings-scroll">
      <div class="section-title">Currency</div>

      <div class="add-curr-form">
        <div class="add-curr-title">Add New Currency</div>
        <div class="add-curr-row">
          <input class="add-curr-input" id="new-curr-code" placeholder="Code e.g. EUR" maxlength="5" autocomplete="off" autocapitalize="characters">
          <input class="add-curr-input" id="new-curr-sym" placeholder="Symbol e.g. â‚¬" maxlength="5" autocomplete="off">
        </div>
        <input class="add-curr-input" id="new-curr-name" placeholder="Name e.g. Euro" autocomplete="off" style="width:100%;margin-bottom:10px">
        <button class="add-curr-btn" style="width:100%" onclick="addCurrency()">+ Add Currency</button>
      </div>

      <div class="section-title">Select Active Currency</div>
      <div class="setting-card" id="currency-list"></div>

      <div class="section-title">Data</div>
      <div class="setting-card">
        <div class="setting-row" onclick="clearAllData()" style="cursor:pointer">
          <div class="setting-icon">ğŸ—‘ï¸</div>
          <div class="setting-info">
            <div class="setting-name">Clear All Data</div>
            <div class="setting-desc">Delete all expense entries</div>
          </div>
          <div class="setting-action">â€º</div>
        </div>
      </div>

      <div class="section-title">About</div>
      <div class="setting-card">
        <div class="setting-row">
          <div class="setting-icon">ğŸ’¸</div>
          <div class="setting-info">
            <div class="setting-name">Spendly v1.0</div>
            <div class="setting-desc">All data stored locally on your device</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- BOTTOM NAV -->
  <div class="bottom-nav">
    <button class="nav-btn active" id="nav-home" onclick="switchTab('home')">
      <span class="nav-icon">ğŸ </span>Home
    </button>
    <button class="nav-btn" id="nav-stats" onclick="switchTab('stats')">
      <span class="nav-icon">ğŸ“Š</span>Stats
    </button>
    <button class="nav-btn" id="nav-settings" onclick="switchTab('settings')">
      <span class="nav-icon">âš™ï¸</span>Settings
    </button>
  </div>
</div>

<!-- ADD / EDIT MODAL -->
<div class="modal-overlay hidden" id="modal-overlay" onclick="handleOverlayClick(event)">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <div class="modal-title" id="modal-title">Add Expense</div>
      <button class="modal-close" onclick="closeModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="edit-id" value="">

      <div class="type-toggle">
        <button class="type-opt active-purchase" id="opt-purchase" onclick="selectType('purchase')">ğŸ›’ Purchase</button>
        <button class="type-opt" id="opt-person" onclick="selectType('person')">ğŸ¤ To Person</button>
      </div>

      <div class="field-group">
        <label class="field-label" id="desc-label">What did you buy?</label>
        <input class="field-input" type="text" id="f-desc" placeholder="e.g. Groceries, Petrol..." autocomplete="off">
      </div>

      <div class="field-group" id="person-field" style="display:none">
        <label class="field-label">Person's Name</label>
        <input class="field-input" type="text" id="f-person" placeholder="e.g. Ravi, Mom, John..." autocomplete="off">
      </div>

      <div class="field-group">
        <label class="field-label">Amount</label>
        <div class="amount-wrap">
          <span class="currency-sym" id="modal-sym">â‚¹</span>
          <input class="field-input has-sym" type="number" id="f-amount" placeholder="0.00" inputmode="decimal" step="0.01" min="0">
        </div>
      </div>

      <div class="field-group">
        <label class="field-label">Category</label>
        <select class="field-input" id="f-category">
          <option value="Food">ğŸ” Food</option>
          <option value="Transport">ğŸš— Transport</option>
          <option value="Shopping">ğŸ›ï¸ Shopping</option>
          <option value="Bills">ğŸ’¡ Bills</option>
          <option value="Health">ğŸ’Š Health</option>
          <option value="Entertainment">ğŸ¬ Entertainment</option>
          <option value="Education">ğŸ“š Education</option>
          <option value="Groceries">ğŸ›’ Groceries</option>
          <option value="Other">ğŸ“¦ Other</option>
        </select>
      </div>

      <div class="field-group">
        <label class="field-label">Date</label>
        <input class="field-input" type="date" id="f-date">
      </div>

      <div class="field-group">
        <label class="field-label">Note (optional)</label>
        <input class="field-input" type="text" id="f-note" placeholder="Any extra detail..." autocomplete="off">
      </div>

      <button class="save-btn" onclick="saveEntry()">Save Expense</button>
      <button class="del-btn" id="del-btn" onclick="deleteEntry()" style="display:none">ğŸ—‘ï¸ Delete Entry</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// â”€â”€ STORAGE â”€â”€
const K_ENTRIES  = 'spendly_entries_v1';
const K_CURR     = 'spendly_currencies_v1';
const K_ACTIVE   = 'spendly_active_curr_v1';

function loadEntries(){ try{return JSON.parse(localStorage.getItem(K_ENTRIES))||[];}catch{return[];} }
function saveEntries(d){ localStorage.setItem(K_ENTRIES,JSON.stringify(d)); }
function loadCurrencies(){
  try{
    const saved = JSON.parse(localStorage.getItem(K_CURR));
    if(saved && saved.length) return saved;
  }catch{}
  return [
    {code:'INR',symbol:'â‚¹',name:'Indian Rupee'},
    {code:'USD',symbol:'$',name:'US Dollar'},
    {code:'KWD',symbol:'KD',name:'Kuwaiti Dinar'}
  ];
}
function saveCurrencies(d){ localStorage.setItem(K_CURR,JSON.stringify(d)); }
function loadActiveCurr(){ return localStorage.getItem(K_ACTIVE)||'INR'; }
function saveActiveCurr(c){ localStorage.setItem(K_ACTIVE,c); }

// â”€â”€ STATE â”€â”€
let entries = loadEntries();
let currencies = loadCurrencies();
let activeCurrCode = loadActiveCurr();
let currentFilter = 'all';
let currentType = 'purchase';
let editId = '';

function getActiveCurr(){
  return currencies.find(c=>c.code===activeCurrCode) || currencies[0] || {code:'USD',symbol:'$',name:'US Dollar'};
}

// â”€â”€ INIT â”€â”€
function init(){
  updateDateLabel();
  renderList();
  renderStats();
  renderCurrencyList();
  updateSymbols();
  // set today's date as default in modal
  document.getElementById('f-date').value = todayStr();
}

function todayStr(){
  const d=new Date();
  return d.toISOString().split('T')[0];
}

function updateDateLabel(){
  const d=new Date();
  document.getElementById('today-date').textContent = d.toLocaleDateString('en-IN',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
}

function updateSymbols(){
  const sym = getActiveCurr().symbol;
  document.getElementById('sym-today').textContent = sym;
  document.getElementById('sym-p').textContent = sym;
  document.getElementById('sym-pp').textContent = sym;
  document.getElementById('modal-sym').textContent = sym;
  document.getElementById('curr-badge').textContent = activeCurrCode + ' ' + sym;
}

// â”€â”€ TABS â”€â”€
function switchTab(tab){
  document.querySelectorAll('.tab-page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('tab-'+tab).classList.add('active');
  document.getElementById('nav-'+tab).classList.add('active');
  if(tab==='stats') renderStats();
  if(tab==='settings') renderCurrencyList();
}

// â”€â”€ FILTER â”€â”€
function setFilter(f, el){
  currentFilter = f;
  document.querySelectorAll('.chip').forEach(c=>{
    c.className='chip';
  });
  el.classList.add('active-'+f);
  renderList();
}

// â”€â”€ RENDER LIST â”€â”€
function renderList(){
  const today = todayStr();
  const listEl = document.getElementById('entries-list');

  let filtered = entries.filter(e=>{
    if(currentFilter==='all') return true;
    return e.type === currentFilter;
  });

  // sort newest first
  filtered = [...filtered].sort((a,b)=>new Date(b.date+' '+b.time)-new Date(a.date+' '+a.time));

  // summary (today only)
  const todayEntries = entries.filter(e=>e.date===today);
  const totalToday = todayEntries.reduce((s,e)=>s+e.amount,0);
  const totalPurchase = todayEntries.filter(e=>e.type==='purchase').reduce((s,e)=>s+e.amount,0);
  const totalPerson = todayEntries.filter(e=>e.type==='person').reduce((s,e)=>s+e.amount,0);
  document.getElementById('total-today').textContent = fmt(totalToday);
  document.getElementById('total-purchase').textContent = fmt(totalPurchase);
  document.getElementById('total-person').textContent = fmt(totalPerson);

  if(filtered.length===0){
    listEl.innerHTML=`<div class="empty-state">
      <div class="empty-icon">${currentFilter==='all'?'ğŸ’¸':currentFilter==='purchase'?'ğŸ›’':'ğŸ¤'}</div>
      <div class="empty-text">No expenses yet.<br>Tap + to add your first entry!</div>
    </div>`;
    return;
  }

  // group by date
  const groups = {};
  filtered.forEach(e=>{
    if(!groups[e.date]) groups[e.date]=[];
    groups[e.date].push(e);
  });

  const sym = getActiveCurr().symbol;
  let html = '';
  Object.keys(groups).sort((a,b)=>new Date(b)-new Date(a)).forEach(date=>{
    const label = formatDateLabel(date);
    html += `<div class="date-group-label">${label}</div>`;
    groups[date].forEach(e=>{
      const icon = getTypeIcon(e.type, e.category);
      const personLine = e.type==='person' && e.person
        ? `<span class="type-badge badge-person">â†’ ${esc(e.person)}</span>`
        : `<span class="type-badge badge-${e.type}">${e.type==='purchase'?'Purchase':'To Person'}</span>`;
      html += `
      <div class="entry-card type-${e.type}" onclick="openEditModal('${e.id}')">
        <div class="entry-icon-wrap">${icon}</div>
        <div class="entry-info">
          <div class="entry-title">${esc(e.desc||e.category)}</div>
          <div class="entry-meta">${personLine}${e.note?`<span style="color:var(--muted2)">Â· ${esc(e.note)}</span>`:''}</div>
        </div>
        <div class="entry-amount type-${e.type}">${sym}${fmt(e.amount)}</div>
      </div>`;
    });
  });
  listEl.innerHTML = html;
}

function formatDateLabel(dateStr){
  const today = todayStr();
  const yesterday = new Date(); yesterday.setDate(yesterday.getDate()-1);
  const yStr = yesterday.toISOString().split('T')[0];
  if(dateStr===today) return 'ğŸ“… Today';
  if(dateStr===yStr) return 'ğŸ“… Yesterday';
  return 'ğŸ“… ' + new Date(dateStr).toLocaleDateString('en-IN',{weekday:'short',day:'numeric',month:'short'});
}

function getTypeIcon(type,cat){
  if(type==='person') return 'ğŸ¤';
  const icons={'Food':'ğŸ”','Transport':'ğŸš—','Shopping':'ğŸ›ï¸','Bills':'ğŸ’¡','Health':'ğŸ’Š','Entertainment':'ğŸ¬','Education':'ğŸ“š','Groceries':'ğŸ›’','Other':'ğŸ“¦'};
  return icons[cat]||'ğŸ’¸';
}

function fmt(n){ return Number(n).toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2}); }
function esc(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// â”€â”€ MODAL â”€â”€
function openAddModal(){
  clearForm();
  document.getElementById('modal-title').textContent='Add Expense';
  document.getElementById('edit-id').value='';
  document.getElementById('del-btn').style.display='none';
  document.getElementById('f-date').value=todayStr();
  document.getElementById('modal-overlay').classList.remove('hidden');
  setTimeout(()=>document.getElementById('f-desc').focus(),350);
}

function openEditModal(id){
  const e=entries.find(x=>x.id===id);
  if(!e) return;
  clearForm();
  document.getElementById('modal-title').textContent='Edit Expense';
  document.getElementById('edit-id').value=id;
  selectType(e.type);
  document.getElementById('f-desc').value=e.desc||'';
  document.getElementById('f-person').value=e.person||'';
  document.getElementById('f-amount').value=e.amount||'';
  document.getElementById('f-note').value=e.note||'';
  document.getElementById('f-date').value=e.date||todayStr();
  const catSel=document.getElementById('f-category');
  for(let i=0;i<catSel.options.length;i++){
    if(catSel.options[i].value===e.category){ catSel.selectedIndex=i; break; }
  }
  document.getElementById('del-btn').style.display='block';
  document.getElementById('modal-overlay').classList.remove('hidden');
}

function closeModal(){
  document.getElementById('modal-overlay').classList.add('hidden');
}

function handleOverlayClick(e){
  if(e.target===document.getElementById('modal-overlay')) closeModal();
}

function clearForm(){
  ['f-desc','f-person','f-amount','f-note'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('f-category').selectedIndex=0;
  selectType('purchase');
}

function selectType(t){
  currentType=t;
  const bp=document.getElementById('opt-purchase');
  const bpp=document.getElementById('opt-person');
  bp.className='type-opt'+(t==='purchase'?' active-purchase':'');
  bpp.className='type-opt'+(t==='person'?' active-person':'');
  document.getElementById('person-field').style.display=(t==='person')?'block':'none';
  document.getElementById('desc-label').textContent=(t==='purchase')?'What did you buy?':'What is it for?';
}

function saveEntry(){
  const desc=document.getElementById('f-desc').value.trim();
  const amount=parseFloat(document.getElementById('f-amount').value);
  const date=document.getElementById('f-date').value||todayStr();

  if(!desc){ showToast('Please enter a description âš ï¸'); return; }
  if(!amount||amount<=0){ showToast('Please enter a valid amount âš ï¸'); return; }

  const entry={
    id: document.getElementById('edit-id').value || Date.now().toString(36)+Math.random().toString(36).slice(2,6),
    type: currentType,
    desc,
    person: document.getElementById('f-person').value.trim(),
    amount,
    category: document.getElementById('f-category').value,
    note: document.getElementById('f-note').value.trim(),
    date,
    time: new Date().toTimeString().slice(0,5),
    currency: activeCurrCode
  };

  const existIdx=entries.findIndex(x=>x.id===entry.id);
  if(existIdx>=0){
    entries[existIdx]=entry;
    showToast('Updated! âœ…');
  } else {
    entries.unshift(entry);
    showToast('Saved! âœ…');
  }

  saveEntries(entries);
  renderList();
  closeModal();
}

function deleteEntry(){
  const id=document.getElementById('edit-id').value;
  if(!id) return;
  if(!confirm('Delete this expense?')) return;
  entries=entries.filter(x=>x.id!==id);
  saveEntries(entries);
  renderList();
  closeModal();
  showToast('Deleted ğŸ—‘ï¸');
}

// â”€â”€ STATS â”€â”€
function renderStats(){
  const sym=getActiveCurr().symbol;
  const total=entries.reduce((s,e)=>s+e.amount,0);
  const totalP=entries.filter(e=>e.type==='purchase').reduce((s,e)=>s+e.amount,0);
  const totalPer=entries.filter(e=>e.type==='person').reduce((s,e)=>s+e.amount,0);

  // category breakdown
  const cats={};
  entries.filter(e=>e.type==='purchase').forEach(e=>{
    cats[e.category]=(cats[e.category]||0)+e.amount;
  });
  const sortedCats=Object.entries(cats).sort((a,b)=>b[1]-a[1]);

  // monthly
  const months={};
  entries.forEach(e=>{
    const m=e.date?e.date.slice(0,7):'';
    if(m) months[m]=(months[m]||0)+e.amount;
  });
  const sortedMonths=Object.entries(months).sort((a,b)=>b[0].localeCompare(a[0])).slice(0,6);

  const purchasePct=total>0?Math.round(totalP/total*100):0;
  const personPct=total>0?Math.round(totalPer/total*100):0;

  let html=`
  <div class="stat-card">
    <div class="stat-card-title">Overall Summary</div>
    <div class="stat-row"><div class="stat-label">Total Entries</div><div class="stat-val">${entries.length}</div></div>
    <div class="stat-row"><div class="stat-label">Total Spent</div><div class="stat-val">${sym}${fmt(total)}</div></div>
    <div class="stat-row"><div class="stat-label">ğŸ›’ Purchases</div><div class="stat-val" style="color:var(--purchase)">${sym}${fmt(totalP)}</div></div>
    <div class="stat-row"><div class="stat-label">ğŸ¤ To Persons</div><div class="stat-val" style="color:var(--person)">${sym}${fmt(totalPer)}</div></div>
  </div>

  <div class="stat-card">
    <div class="stat-card-title">Expense Split</div>
    <div style="display:flex;justify-content:space-between;margin-bottom:8px">
      <span style="font-size:12px;color:var(--purchase);font-weight:600">Purchases ${purchasePct}%</span>
      <span style="font-size:12px;color:var(--person);font-weight:600">To Person ${personPct}%</span>
    </div>
    <div class="bar-wrap" style="height:12px">
      <div class="bar-fill bar-purchase" style="width:${purchasePct}%"></div>
    </div>
    <div class="bar-wrap" style="height:12px;margin-top:6px">
      <div class="bar-fill bar-person" style="width:${personPct}%"></div>
    </div>
  </div>`;

  if(sortedCats.length){
    const maxCat=sortedCats[0][1];
    html+=`<div class="stat-card"><div class="stat-card-title">Top Categories</div>`;
    sortedCats.slice(0,6).forEach(([cat,amt])=>{
      const pct=Math.round(amt/maxCat*100);
      html+=`<div class="stat-row" style="flex-direction:column;align-items:flex-start">
        <div style="display:flex;width:100%;justify-content:space-between">
          <span class="stat-label">${getTypeIcon('purchase',cat)} ${cat}</span>
          <span class="stat-val" style="color:var(--purchase)">${sym}${fmt(amt)}</span>
        </div>
        <div class="bar-wrap" style="width:100%;margin-top:6px"><div class="bar-fill bar-purchase" style="width:${pct}%"></div></div>
      </div>`;
    });
    html+=`</div>`;
  }

  if(sortedMonths.length){
    html+=`<div class="stat-card"><div class="stat-card-title">Monthly History</div>`;
    sortedMonths.forEach(([m,amt])=>{
      const [yr,mo]=m.split('-');
      const label=new Date(yr,parseInt(mo)-1).toLocaleDateString('en-IN',{month:'long',year:'numeric'});
      html+=`<div class="stat-row"><div class="stat-label">${label}</div><div class="stat-val">${sym}${fmt(amt)}</div></div>`;
    });
    html+=`</div>`;
  }

  if(entries.length===0){
    html=`<div class="empty-state"><div class="empty-icon">ğŸ“Š</div><div class="empty-text">No data yet.<br>Add expenses to see stats!</div></div>`;
  }

  document.getElementById('stats-content').innerHTML=html;
}

// â”€â”€ CURRENCY â”€â”€
function renderCurrencyList(){
  const el=document.getElementById('currency-list');
  if(!currencies.length){
    el.innerHTML=`<div style="padding:16px;text-align:center;color:var(--muted);font-size:13px">No currencies. Add one above.</div>`;
    return;
  }
  const defaultCodes=['INR','USD','KWD'];
  el.innerHTML=currencies.map(c=>`
    <div class="currency-item" onclick="setActiveCurrency('${c.code}')">
      <div class="curr-sym">${c.symbol}</div>
      <div class="curr-info">
        <div class="curr-name">${esc(c.name)}</div>
        <div class="curr-code">${c.code}</div>
      </div>
      <div class="curr-active">${activeCurrCode===c.code?'âœ…':''}</div>
      ${!defaultCodes.includes(c.code)?`<button class="curr-delete" onclick="event.stopPropagation();deleteCurrency('${c.code}')">âœ•</button>`:''}
    </div>`).join('');
}

function setActiveCurrency(code){
  activeCurrCode=code;
  saveActiveCurr(code);
  updateSymbols();
  renderList();
  renderCurrencyList();
  showToast('Currency set to '+code+' âœ…');
}

function addCurrency(){
  const code=document.getElementById('new-curr-code').value.trim().toUpperCase();
  const symbol=document.getElementById('new-curr-sym').value.trim();
  const name=document.getElementById('new-curr-name').value.trim();
  if(!code||!symbol||!name){ showToast('Fill all currency fields âš ï¸'); return; }
  if(currencies.find(c=>c.code===code)){ showToast(code+' already exists âš ï¸'); return; }
  currencies.push({code,symbol,name});
  saveCurrencies(currencies);
  document.getElementById('new-curr-code').value='';
  document.getElementById('new-curr-sym').value='';
  document.getElementById('new-curr-name').value='';
  renderCurrencyList();
  showToast(name+' added! ğŸ’±');
}

function deleteCurrency(code){
  if(!confirm('Remove '+code+' currency?')) return;
  currencies=currencies.filter(c=>c.code!==code);
  saveCurrencies(currencies);
  if(activeCurrCode===code){
    activeCurrCode=currencies[0]?.code||'USD';
    saveActiveCurr(activeCurrCode);
    updateSymbols();
  }
  renderCurrencyList();
  showToast('Removed âœ…');
}

function clearAllData(){
  if(!confirm('Delete ALL expenses? This cannot be undone!')) return;
  entries=[];
  saveEntries(entries);
  renderList();
  renderStats();
  showToast('All data cleared ğŸ—‘ï¸');
}

// â”€â”€ TOAST â”€â”€
let toastTimer;
function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>t.classList.remove('show'),2400);
}

// â”€â”€ START â”€â”€
init();
</script>
</body>
</html>
